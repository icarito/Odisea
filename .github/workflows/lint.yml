name: Lint GDScript & Static Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  gdformat:
    name: GDScript Format & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install gdtoolkit
        run: |
          pip install gdtoolkit==4.2.2

      - name: Run gdlint
        run: |
          echo '>>> Running gdlint'
          # Lint solo sobre scripts fuera de addons para evitar ruido de vendor
          if ls scenes/scripts/**/*.gd 1> /dev/null 2>&1; then
            gdlint $(git ls-files 'scenes/scripts/**/*.gd') || true
          else
            echo 'No se encontraron scripts en scenes/scripts para lint.'
          fi

      - name: Report summary
        if: always()
        run: |
          echo '### Resultado Lint GDScript' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'Revisa el log anterior para detalles. (Los errores no fallan el build por ahora).' >> $GITHUB_STEP_SUMMARY

  godot-validate:
    name: Godot Headless Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Godot Headless
        run: |
          wget https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_linux.x86_64.zip -O godot.zip
          unzip godot.zip -d godot_bin
          chmod +x godot_bin/Godot_v4.5.1-stable_linux.x86_64

      - name: Validate project loads
        run: |
          ./godot_bin/Godot_v4.5.1-stable_linux.x86_64 --headless --path . --quit || true

      - name: Report summary
        if: always()
        run: |
          echo '### Validación headless de Godot' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'Se ejecutó Godot en modo headless para verificar que el proyecto carga.' >> $GITHUB_STEP_SUMMARY
